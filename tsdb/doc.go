package tsdb

/*


━━━━━━━━━━━━━━━━━━━━━━━━━━Layout of Shard━━━━━━━━━━━━━━━━━━━━━━━━

Each shard contains a MemoryDatabase.
┌──────────────────┬──────────────────┐
│      Shard       │   Shard          │
├──────────────────┼──────────────────┤
│  Memory Database │  Memory Database │
└──────────────────┴──────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━Layout of memDB━━━━━━━━━━━━━━━━━━━━━━━━

+--------------+       +--------------+
|              |------>|              |
|              |-+     |              |-+
|   Memory     | |     |  Metric      | |
|   Database   | |-+   |  Store       | |-+
|   RwMutex    | | |   |  RWMutex     | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |              | | |
+-+------------+ | |   +--------------+ | |
  +--------------+ |     +-----|--------+ |
    +--------------+       +---|----------+
                               |
                               V
+--------------+       +--------------+
|              |<------|              |
|              |-+     |              |-+
|              | |     |              | |
|   Field      | |-+   |  TimeSeries  | |-+
|   Store      | | |   |  Store       | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |              | | |
|              | | |   |   SpinLock   | | |
+--------------+ | |   +--------------+ | |
  +----|---------+ |     +--------------+ |
    +--|-----------+       +--------------+
       |
       V
+--------------+
|              |
|              |-+
|              | |
|   Segment    | |-+
|   Store      | | |
|              | | |
|              | | |
|              | | |
|              | | |
|              | | |
+--------------+ | |
  +--------------+ |
    +--------------+


━━━━━━━━━━━━━━━━━━━━━━━━━━Layout of metric table━━━━━━━━━━━━━━━━━━━━━━━━

                   Level1
                   +---------+---------+---------+---------+---------+---------+
                   | Metric  | Metric  | Metric  | Metric  | Metric  | Footer  |
                   | Block   | Block   | Block   | Offset  | Index   |         |
                   +---------+---------+---------+---------+---------+---------+
                  /           \                   \        |\        +-------------------------------+
                 /             \                   \       | +--------------------------------+       \
                /               \                   \      +-----------------------------+     \       \
               /                 \                   +--------------+                     \     \       \
  +-----------+                   +--------------------------+       \                     \     \       \
 /                 Level2                                     \       \                     \     \       \
v--------+--------+-----------------+--------+--------+--------v       v--------+---+--------v     v-------v
| Series | Series | Series | Series | Series | Fields | Footer |       | Offset |...| Offset |     | Metric|
| Entry  | Entry  | Entry  | Offset | Index  |  Meta  |        |       |        |   |        |     | Bitmap|
+--------+--------+--------+--------+--------+--------+--------+       +--------+---+--------+     +-------+
|         \                 \       |\        \
|          \                 \      | \        +-----------------------------------------------+
|           \                 \     |  +----------------------------------------------+         \
|            \                 \    +---------------------------------------------+    \         \
|             \                 +-----------------------------+                    \    \         \
|              +------------------------------------+          \                    \    \         \
|                  Level3                            \          \                    \    \         \
v--------+--------+--------+--------+--------+--------v          v--------+---+-------v    v---------v
| Fields | Data   |  Data  | Data   | Data   |  Data  |          | Offset |...| Offset|    |seriesID |
| Info   |        |        |        |        |        |          |        |   |       |    | Bitmap  |
+--------+--------+--------+--------+--------+--------+          +--------+---+-------+    +---------+


Level1(KV table: MetricBlocks, Offset, Keys)
┌───────────────────────────────────────────┬───────────────────────────────────────────┐
│               Metric Blocks               │           Offset And Keys                 │
├──────────┬──────────┬──────────┬──────────┼──────────┬──────────┬──────────┬──────────┤
│  length  │  Metric  │  length  │  Metric  │  length  │  Offset  │  length  │  Keys    │
│          │  Block1  │          │  Block2  │          │          │          │          │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ uvariant │  N Bytes │ uvariant │ N Bytes  │ uvariant │  N Bytes │ uvariant │  N Bytes │
└──────────┴──────────┴──────────┴──────────^──────────┴──────────^──────────┴──────────┘
                                            |                     |
                                       posOfOffset             posOfKeys

Level1(KV table: Footer)
┌──────────────────────────────────────────────────────┐
│                    Footer                            │
├──────────┬──────────┬──────────┬──────────┬──────────┤
│  length  │ position │ position │ Version  │  Magic   │
│          │ OfOffset │ OfKeys   │          │  Number  │
├──────────┼──────────┼──────────┼──────────┼──────────┤
│  1 Byte  │ 4 Bytes  │ 4 Bytes  │ 1 Bytes  │  8 Bytes │
└──────────┴──────────┴──────────┴──────────┴──────────┘



Level2(Fields Meta, Fields Footer)
┌─────────────────────────────────────────────────────────────────┬───────────────────────────────────────────┐
│               Fields Meta                                       │           Fields Footer                   │
├──────────┬──────────┬──────────┬──────────┬──────────┬──────────┼──────────┬──────────┬──────────┬──────────┤
│StartTime │ EndTime  │ Count    │ FieldID  │  Field   │          │ OffsetOf │ OffsetOf │ OffsetOf │  CRC32   │
│ (delta)  │ (delta)  │          │ (uint16) │  Type    │  ......  │ TSOffset │ TSIndex  │FieldsMeta│ Checksum │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ uvariant │ uvariant │ uvariant │ 2 Bytes  │ 1 Byte   │ 3N Bytes │ 4 Bytes  │ 4 Bytes  │ 4 Bytes  │  4 Bytes │
└──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘

Level3(Fields Info, Fields Data)
┌─────────────────────────────────────────────────────────────────┬─────────────────────┐
│               Fields Info                                       │   Fields Data       │
├──────────┬──────────┬──────────┬──────────┬──────────┬──────────┼──────────┬──────────┤
│StartTime │ EndTime  │ BitArray │ BitArray │  Data1   │  Data2   │  Data1   │ Data2    │
│ (delta)  │ (delta)  │  Length  │          │  Length  │  Length  │          │          │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ uvariant │ uvariant │ uvariant │ N Bytes  │ uvariant │ uvariant │ N Bytes  │ N Bytes  │
└──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘
bit array example(10101001, 1010100110101001)


*/
